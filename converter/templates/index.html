<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1, width=device-width" />
    {% load static %}
    <link rel="stylesheet" href="{% static 'index.css' %}" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inria+Sans:wght@400&display=swap" />
  </head>

  <body>
    <div class="slide-169-1">
      <div class="main">
        <div class="main-frame">
          <h2 class="main-heading">Import your list from HiAnime.to to MyAnimeList.net</h2>
          <div class="main-desc">This program automates the process of transferring anime lists from HiAnime.to to MyAnimeList.net.</div>
          <div class="hline"></div>
        </div>
        <form id="transferForm" class="form">
          {% csrf_token %}
          <div class="connect-component">
            <div class="comp-heading">
              <div class="sub">Step 1: Authorize MyAnimeList.net to gain access to your /////////////</div>
            </div>
            <div class="comp-input-frame">
              <button class="button" type="button" onclick="openOauth()" id="oauth-button">
                <div class="button-text">Connect MyAnimeList.net</div>
              </button>
              <div class="status" id="oauth-status">Status: {{oauth_status}}</div>
            </div>
          </div>
          <div class="guide-component">
            <div class="comp-heading1">
              <div class="sub">Step 2: Paste connect.sid cookie from <a href="https://hianime.to/">HiAnime.to</a> to import your /////////////</div>
              <a class="showme">Show me how</a>
            </div>
            <div class="comp-guide">
              <div class="instructions">
                <div class="using-browser-go-container">
                  <p class="using-browser">Using browser:</p>
                  <ul class="guidelins">
                    <li class="guide-text">Go to <a href="https://hianime.to/">HiAnime.to</a>.</li>
                    <li class="guide-text">Press F12 to open the developer tools.</li>
                    <li class="guide-text">Go to the Application tab.</li>
                    <li class="guide-text">Click on Cookies > https://hianime.to.</li>
                    <li class="guide-text">Copy the value of the connect.sid cookie.</li>
                  </ul>
                </div>
              </div>
              <div class="vline"></div>
              <div class="instructions">
                <div class="using-browser-go-container">
                  <p class="using-browser">Using Extension:</p>
                  <ul class="guidelins">
                    <li class="guide-text">Install <a href="https://cookie-editor.com/">Cookie-Editor</a>.</li>
                    <li class="guide-text">Go to <a href="https://hianime.to/">HiAnime.to</a>.</li>
                    <li class="guide-text">Click on the extension icon.</li>
                    <li class="guide-text">Click on the connect.sid cookie.</li>
                    <li class="guide-text">Copy the value of the connect.sid cookie.</li>
                  </ul>
                </div>
              </div>
            </div>
            <div class="input-component">
              <div class="input-desc">connect.sid cookie:</div>
              <input class="input" id="input-text" name="hi_cookie" placeholder="HiAnimeCookie" value="{{ hi_cookie }}" type="text" />
            </div>
          </div>
          <div class="connect-component">
            <div class="comp-heading2">
              <div class="sub">Step 3: Transfer your /////////////</div>
            </div>
            <div class="comp-input-frame">
              <button class="button" type="button" id="submit">
                <div class="button-text">Transfer</div>
              </button>
              <div class="status" id="transfer-status"></div>
            </div>
          </div>
        </form>
      </div>
    </div>

    <script>
      // Check form fields on load
      window.onload = function () {
        checkOauthStatus();
        checkField();
      };

      function checkOauthStatus() {
        if (document.getElementById("oauth-status").innerText !== "Status: Connected") {
          enableButton(document.getElementById("oauth-button"));
        } else {
          disableButton(document.getElementById("oauth-button"));
          document.getElementById("oauth-status").style.color = "hsl(120, 100%, 80%)";
        }
        checkFilled();
      }

      function disableButton(element) {
        element.style.cursor = "not-allowed";
        element.disabled = true;
        element.classList.remove("button-hover");
      }

      function enableButton(element) {
        element.style.cursor = "pointer";
        element.disabled = false;
        element.classList.add("button-hover");
      }

      function disableInput(element) {
        element.style.cursor = "not-allowed";
        element.disabled = true;
      }

      function enableInput(element) {
        element.style.cursor = "pointer";
        element.disabled = false;
      }

      function checkFilled() {
        var status = "Status:";
        if (document.getElementById("input-text").value === "") {
          status += " Cookie field empty";
        }
        if (document.getElementById("oauth-status").innerText !== "Status: Connected") {
          status += " MyAnimeList.net Not Connected";
        }
        if (status === "Status:") {
          status += " Ready to Transfer";
          document.getElementById("transfer-status").style.color = "hsl(120, 100%, 80%)";
          enableButton(document.getElementById("submit"));
        } else {
          document.getElementById("transfer-status").style.color = "hsl(0, 100%, 80%)";
          disableButton(document.getElementById("submit"));
        }
        document.getElementById("transfer-status").innerText = status;
      }

      function checkField() {
        if (document.getElementById("input-text").value !== "") {
          document.getElementById("input-text").style.borderColor = "hsl(237, 100%, 80%)";
        } else {
          document.getElementById("input-text").style.borderColor = "hsl(0, 100%, 80%)";
        }
      }

      document.getElementById("input-text").oninput = function () {
        checkField();
        checkFilled();
      };

      document.getElementsByClassName("showme")[0].addEventListener("click", function () {
        guide = document.getElementsByClassName("comp-guide")[0];
        guide.style.display = guide.style.display === "flex" ? "none" : "flex";
      });

      // document.getElementById("submit").addEventListener("click", async function () {
      //   disableButton(document.getElementById("submit"));
      //   disableInput(document.getElementById("input-text"));
      //   document.getElementById("transfer-status").innerText = "Requesting list...";

      //   var formData = new FormData(document.getElementById("transferForm"));

      //   try {
      //     // Step 1: Request the HiAnime list
      //     let response = await fetch("/get-list", {
      //       method: "POST",
      //       body: formData,
      //       headers: {
      //         "X-CSRFToken": formData.get("csrfmiddlewaretoken"),
      //       },
      //     });
      //     let data = await response.json();
      //     document.getElementById("transfer-status").innerText = data.status;
      //     if (response.status !== 200) throw new Error(data.status);

      //     // Step 2: Find MAL IDs
      //     document.getElementById("transfer-status").innerText = "Finding MAL IDs...";
      //     response = await fetch("/populate-list", {
      //       method: "POST",
      //       headers: {
      //         "X-CSRFToken": formData.get("csrfmiddlewaretoken"),
      //       },
      //     });
      //     data = await response.json();
      //     document.getElementById("transfer-status").innerText = data.status;
      //     if (response.status !== 200) throw new Error(data.status);

      //     // Step 3: Import to MAL
      //     document.getElementById("transfer-status").innerText = "Importing to MAL...";
      //     response = await fetch("/import-to-mal", {
      //       method: "POST",
      //       headers: {
      //         "X-CSRFToken": formData.get("csrfmiddlewaretoken"),
      //       },
      //     });
      //     data = await response.json();
      //     document.getElementById("transfer-status").innerText = data.status;
      //     if (response.status !== 200) throw new Error(data.status);

      //     document.getElementById("transfer-status").style.color = "hsl(120, 100%, 80%)";
      //   } catch (error) {
      //     document.getElementById("transfer-status").innerText = error.message;
      //     document.getElementById("transfer-status").style.color = "hsl(0, 100%, 80%)";
      //   } finally {
      //     enableButton(document.getElementById("submit"));
      //     enableInput(document.getElementById("input-text"));
      //   }
      // });
      document.getElementById("submit").addEventListener("click", function () {
        disableButton(document.getElementById("submit"));
        disableInput(document.getElementById("input-text"));

        const formData = new FormData(document.getElementById("transferForm"));
        formData.append("hi_cookie", document.getElementById("input-text").value);

        function makeRequest(url, statusMessage) {
          document.getElementById("transfer-status").innerText = statusMessage;

          return fetch(url, {
            method: "POST",
            body: formData,
            headers: {
              "X-CSRFToken": formData.get("csrfmiddlewaretoken"),
            },
          }).then((response) =>
            response.json().then((data) => {
              document.getElementById("transfer-status").innerText = data.status;
              if (response.status !== 200) {
                throw new Error(data.status);
              }
              return data;
            })
          );
        }

        makeRequest("/get-hi", "Requesting list...")
          .then(() => makeRequest("/prepare", "Processing list..."))
          .then(() => makeRequest("/post-mal", "Importing to MAL..."))
          .then(() => {
            document.getElementById("transfer-status").style.color = "hsl(120, 100%, 80%)";
          })
          .catch((error) => {
            document.getElementById("transfer-status").innerText = error.message;
            document.getElementById("transfer-status").style.color = "hsl(0, 100%, 80%)";
          })
          .finally(() => {
            enableButton(document.getElementById("submit"));
            enableInput(document.getElementById("input-text"));
          });
      });

      function openOauth() {
        window.location.href = "/oauth";
      }
    </script>
  </body>
</html>
